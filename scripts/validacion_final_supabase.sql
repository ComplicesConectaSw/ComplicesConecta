-- =====================================================
-- VALIDACI√ìN FINAL SUPABASE - VERIFICACI√ìN POST-CORRECCIONES
-- ComplicesConecta v2.1.1 - Validaci√≥n Integral del Sistema
-- Fecha: 06 de septiembre, 2025 - 04:59 hrs
-- =====================================================

-- üîç VALIDACI√ìN FINAL: VERIFICAR QUE TODAS LAS CORRECCIONES SE APLICARON CORRECTAMENTE
DO $$
DECLARE
    -- Contadores para m√©tricas finales
    tablas_existentes INTEGER := 0;
    columnas_existentes INTEGER := 0;
    funciones_existentes INTEGER := 0;
    triggers_existentes INTEGER := 0;
    buckets_existentes INTEGER := 0;
    tablas_con_rls INTEGER := 0;
    total_politicas INTEGER := 0;
    indices_performance INTEGER := 0;
    
    -- Arrays de elementos cr√≠ticos
    tablas_criticas TEXT[] := ARRAY[
        'profiles', 'user_roles', 'invitations', 'gallery_permissions',
        'images', 'image_permissions', 'gallery_access_requests',
        'chat_rooms', 'chat_members', 'messages', 'chat_invitations',
        'user_likes', 'matches', 'match_interactions'
    ];
    
    columnas_criticas TEXT[] := ARRAY[
        'interests', 'looking_for', 'swinger_experience', 
        'age_range_min', 'age_range_max', 'max_distance'
    ];
    
    funciones_criticas TEXT[] := ARRAY[
        'has_role', 'handle_new_user', 'update_updated_at_column', 
        'exec_sql', 'detect_mutual_match', 'get_user_matches', 'get_potential_matches'
    ];
    
    triggers_criticos TEXT[] := ARRAY[
        'trg_profiles_updated_at', 'trg_invitations_updated_at', 
        'trg_images_updated_at', 'on_auth_user_created'
    ];
    
    buckets_criticos TEXT[] := ARRAY['profile-images', 'gallery-images', 'chat-media'];
    
    -- Variables temporales
    tabla TEXT;
    columna TEXT;
    funcion TEXT;
    trigger_name TEXT;
    bucket_name TEXT;
    rls_activo BOOLEAN;
    num_politicas INTEGER;
    
    -- Puntuaci√≥n final
    puntuacion_total NUMERIC := 0;
    puntuacion_maxima NUMERIC := 700; -- 100 puntos por cada categor√≠a
    
BEGIN
    RAISE NOTICE 'üîç === VALIDACI√ìN FINAL POST-CORRECCIONES ===';
    RAISE NOTICE '‚è∞ Iniciado: %', NOW();
    RAISE NOTICE '';
    
    -- ‚úÖ 1. VALIDAR TABLAS CR√çTICAS (100 puntos)
    RAISE NOTICE 'üìã 1. VALIDANDO TABLAS CR√çTICAS...';
    FOREACH tabla IN ARRAY tablas_criticas
    LOOP
        IF EXISTS (SELECT 1 FROM information_schema.tables 
                  WHERE table_schema = 'public' AND table_name = tabla) THEN
            tablas_existentes := tablas_existentes + 1;
            RAISE NOTICE '   ‚úÖ %', tabla;
        ELSE
            RAISE NOTICE '   ‚ùå FALTA: %', tabla;
        END IF;
    END LOOP;
    
    puntuacion_total := puntuacion_total + (tablas_existentes * 100.0 / array_length(tablas_criticas, 1));
    RAISE NOTICE '   üìä Resultado: %/% tablas (%% puntos)', 
        tablas_existentes, array_length(tablas_criticas, 1),
        ROUND(tablas_existentes * 100.0 / array_length(tablas_criticas, 1));
    
    -- ‚úÖ 2. VALIDAR COLUMNAS CR√çTICAS EN PROFILES (100 puntos)
    RAISE NOTICE '';
    RAISE NOTICE 'üìã 2. VALIDANDO COLUMNAS CR√çTICAS EN PROFILES...';
    FOREACH columna IN ARRAY columnas_criticas
    LOOP
        IF EXISTS (SELECT 1 FROM information_schema.columns 
                  WHERE table_schema = 'public' 
                  AND table_name = 'profiles' 
                  AND column_name = columna) THEN
            columnas_existentes := columnas_existentes + 1;
            RAISE NOTICE '   ‚úÖ profiles.%', columna;
        ELSE
            RAISE NOTICE '   ‚ùå FALTA: profiles.%', columna;
        END IF;
    END LOOP;
    
    puntuacion_total := puntuacion_total + (columnas_existentes * 100.0 / array_length(columnas_criticas, 1));
    RAISE NOTICE '   üìä Resultado: %/% columnas (%% puntos)', 
        columnas_existentes, array_length(columnas_criticas, 1),
        ROUND(columnas_existentes * 100.0 / array_length(columnas_criticas, 1));
    
    -- ‚úÖ 3. VALIDAR FUNCIONES CR√çTICAS (100 puntos)
    RAISE NOTICE '';
    RAISE NOTICE '‚öôÔ∏è 3. VALIDANDO FUNCIONES CR√çTICAS...';
    FOREACH funcion IN ARRAY funciones_criticas
    LOOP
        IF EXISTS (SELECT 1 FROM information_schema.routines 
                  WHERE routine_schema = 'public' 
                  AND routine_name = funcion 
                  AND routine_type = 'FUNCTION') THEN
            funciones_existentes := funciones_existentes + 1;
            RAISE NOTICE '   ‚úÖ %', funcion;
        ELSE
            RAISE NOTICE '   ‚ùå FALTA: %', funcion;
        END IF;
    END LOOP;
    
    puntuacion_total := puntuacion_total + (funciones_existentes * 100.0 / array_length(funciones_criticas, 1));
    RAISE NOTICE '   üìä Resultado: %/% funciones (%% puntos)', 
        funciones_existentes, array_length(funciones_criticas, 1),
        ROUND(funciones_existentes * 100.0 / array_length(funciones_criticas, 1));
    
    -- ‚úÖ 4. VALIDAR TRIGGERS (100 puntos)
    RAISE NOTICE '';
    RAISE NOTICE 'üîÑ 4. VALIDANDO TRIGGERS AUTOM√ÅTICOS...';
    FOREACH trigger_name IN ARRAY triggers_criticos
    LOOP
        IF EXISTS (SELECT 1 FROM information_schema.triggers 
                  WHERE trigger_schema = 'public' 
                  AND trigger_name = trigger_name) THEN
            triggers_existentes := triggers_existentes + 1;
            RAISE NOTICE '   ‚úÖ %', trigger_name;
        ELSE
            RAISE NOTICE '   ‚ùå FALTA: %', trigger_name;
        END IF;
    END LOOP;
    
    puntuacion_total := puntuacion_total + (triggers_existentes * 100.0 / array_length(triggers_criticos, 1));
    RAISE NOTICE '   üìä Resultado: %/% triggers (%% puntos)', 
        triggers_existentes, array_length(triggers_criticos, 1),
        ROUND(triggers_existentes * 100.0 / array_length(triggers_criticos, 1));
    
    -- ‚úÖ 5. VALIDAR BUCKETS DE STORAGE (100 puntos)
    RAISE NOTICE '';
    RAISE NOTICE 'üóÑÔ∏è 5. VALIDANDO BUCKETS DE STORAGE...';
    FOREACH bucket_name IN ARRAY buckets_criticos
    LOOP
        IF EXISTS (SELECT 1 FROM storage.buckets WHERE name = bucket_name) THEN
            buckets_existentes := buckets_existentes + 1;
            RAISE NOTICE '   ‚úÖ %', bucket_name;
        ELSE
            RAISE NOTICE '   ‚ùå FALTA: %', bucket_name;
        END IF;
    END LOOP;
    
    puntuacion_total := puntuacion_total + (buckets_existentes * 100.0 / array_length(buckets_criticos, 1));
    RAISE NOTICE '   üìä Resultado: %/% buckets (%% puntos)', 
        buckets_existentes, array_length(buckets_criticos, 1),
        ROUND(buckets_existentes * 100.0 / array_length(buckets_criticos, 1));
    
    -- ‚úÖ 6. VALIDAR RLS Y POL√çTICAS (100 puntos)
    RAISE NOTICE '';
    RAISE NOTICE 'üîí 6. VALIDANDO RLS Y POL√çTICAS DE SEGURIDAD...';
    FOREACH tabla IN ARRAY tablas_criticas
    LOOP
        IF EXISTS (SELECT 1 FROM information_schema.tables 
                  WHERE table_schema = 'public' AND table_name = tabla) THEN
            
            -- Verificar RLS activo
            SELECT relrowsecurity INTO rls_activo
            FROM pg_class c
            JOIN pg_namespace n ON c.relnamespace = n.oid
            WHERE n.nspname = 'public' AND c.relname = tabla;
            
            -- Contar pol√≠ticas
            SELECT COUNT(*) INTO num_politicas
            FROM pg_policies 
            WHERE schemaname = 'public' AND tablename = tabla;
            
            IF rls_activo THEN
                tablas_con_rls := tablas_con_rls + 1;
                total_politicas := total_politicas + num_politicas;
                RAISE NOTICE '   ‚úÖ % - RLS: ‚úì | Pol√≠ticas: %', tabla, num_politicas;
            ELSE
                RAISE NOTICE '   ‚ùå % - RLS: ‚úó | Pol√≠ticas: %', tabla, num_politicas;
            END IF;
        END IF;
    END LOOP;
    
    puntuacion_total := puntuacion_total + (tablas_con_rls * 100.0 / array_length(tablas_criticas, 1));
    RAISE NOTICE '   üìä Resultado: %/% tablas con RLS (%% puntos)', 
        tablas_con_rls, array_length(tablas_criticas, 1),
        ROUND(tablas_con_rls * 100.0 / array_length(tablas_criticas, 1));
    RAISE NOTICE '   üìä Total pol√≠ticas: % implementadas', total_politicas;
    
    -- ‚úÖ 7. VALIDAR √çNDICES DE PERFORMANCE (100 puntos)
    RAISE NOTICE '';
    RAISE NOTICE 'üöÄ 7. VALIDANDO √çNDICES DE PERFORMANCE...';
    
    SELECT COUNT(*) INTO indices_performance
    FROM pg_indexes 
    WHERE schemaname = 'public' 
    AND indexname NOT LIKE '%_pkey'
    AND (indexname LIKE '%user_likes%' 
         OR indexname LIKE '%matches%' 
         OR indexname LIKE '%profiles%');
    
    -- Puntuaci√≥n basada en n√∫mero de √≠ndices cr√≠ticos (m√≠nimo 4 esperados)
    puntuacion_total := puntuacion_total + LEAST(indices_performance * 25.0, 100);
    RAISE NOTICE '   üìä √çndices cr√≠ticos encontrados: %', indices_performance;
    RAISE NOTICE '   üìä Puntuaci√≥n √≠ndices: %% puntos', ROUND(LEAST(indices_performance * 25.0, 100));
    
    -- üìä CALCULAR PUNTUACI√ìN FINAL
    RAISE NOTICE '';
    RAISE NOTICE 'üìä === PUNTUACI√ìN FINAL DEL SISTEMA ===';
    RAISE NOTICE 'üèÜ PUNTUACI√ìN TOTAL: %/% (%% de 100%%)', 
        ROUND(puntuacion_total), ROUND(puntuacion_maxima), 
        ROUND(puntuacion_total * 100.0 / puntuacion_maxima);
    
    -- Determinar estado del sistema
    IF puntuacion_total >= 650 THEN
        RAISE NOTICE 'üéâ ESTADO: EXCELENTE - SISTEMA PRODUCTION-READY';
    ELSIF puntuacion_total >= 550 THEN
        RAISE NOTICE '‚úÖ ESTADO: BUENO - Listo para producci√≥n con monitoreo';
    ELSIF puntuacion_total >= 450 THEN
        RAISE NOTICE '‚ö†Ô∏è ESTADO: ACEPTABLE - Requiere correcciones menores';
    ELSE
        RAISE NOTICE '‚ùå ESTADO: CR√çTICO - Requiere correcciones inmediatas';
    END IF;
    
    -- Resumen de componentes
    RAISE NOTICE '';
    RAISE NOTICE 'üìã === RESUMEN DE COMPONENTES ===';
    RAISE NOTICE 'üìä Tablas cr√≠ticas: %/%', tablas_existentes, array_length(tablas_criticas, 1);
    RAISE NOTICE 'üìä Columnas profiles: %/%', columnas_existentes, array_length(columnas_criticas, 1);
    RAISE NOTICE 'üìä Funciones cr√≠ticas: %/%', funciones_existentes, array_length(funciones_criticas, 1);
    RAISE NOTICE 'üìä Triggers autom√°ticos: %/%', triggers_existentes, array_length(triggers_criticos, 1);
    RAISE NOTICE 'üìä Buckets storage: %/%', buckets_existentes, array_length(buckets_criticos, 1);
    RAISE NOTICE 'üìä Tablas con RLS: %/%', tablas_con_rls, array_length(tablas_criticas, 1);
    RAISE NOTICE 'üìä Pol√≠ticas RLS: % implementadas', total_politicas;
    RAISE NOTICE 'üìä √çndices performance: % cr√≠ticos', indices_performance;
    
    RAISE NOTICE '';
    RAISE NOTICE '‚è∞ Validaci√≥n completada: %', NOW();
    RAISE NOTICE 'üéØ Sistema ComplicesConecta v2.1.1 - Auditor√≠a Finalizada';
    RAISE NOTICE '';
    
END $$;
